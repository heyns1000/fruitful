name: Auto Merge Ecosystem PRs
on:
  pull_request:
    types: [labeled, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    if: |
      (github.event.label.name == 'automerge' ||
       github.event.label.name == 'omnigrid-favorable' ||
       contains(fromJSON('[\"copilot\", \"github-actions[bot]\"]'), github.event.pull_request.user.login)) &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Sovereign Goals Alignment
        id: sovereign_check
        run: |
          echo "üéØ Checking sovereign goals and cascade integration requirements..."
          
          # Check if this PR is part of omnigrid cascade or fruitful automation backbone
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Load PR alignment configuration to check for fruitful integration target
          FRUITFUL_TARGET_PR=$(python3 -c "import json; data=json.load(open('config/ecosystem-repos.json')); print(data['pr_alignment']['fruitful_integration_target'].split('#')[1])" 2>/dev/null || echo "5")
          
          # Mark as omnigrid-favorable if it's part of cascade integration
          if [[ "$PR_TITLE" == *"omnigrid"* ]] || [[ "$PR_TITLE" == *"cascade"* ]] || [[ "$PR_NUMBER" == "$FRUITFUL_TARGET_PR" ]]; then
            echo "omnigrid_favorable=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR marked as omnigrid-favorable automation backbone"
          else
            echo "omnigrid_favorable=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto Merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const isOmnigridFavorable = '${{ steps.sovereign_check.outputs.omnigrid_favorable }}' === 'true';
            
            // Check if mergeable
            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            if (prData.mergeable && prData.mergeable_state === 'clean') {
              // Add omnigrid-favorable label if applicable
              if (isOmnigridFavorable) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['omnigrid-favorable', 'automation-backbone']
                });
                console.log('‚úÖ Added omnigrid-favorable and automation-backbone labels');
              }
              
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'merge',
                commit_title: `‚úÖ Auto-merge: ${pr.title}`,
                commit_message: `FAA Actuary Mastery‚Ñ¢ automated merge${isOmnigridFavorable ? ' (omnigrid-favorable)' : ''}`
              });
              
              console.log(`‚úÖ PR #${pr.number} auto-merged successfully`);
              
              // Trigger cascade integration if this is fruitful#5 type PR
              if (isOmnigridFavorable) {
                console.log('üîÑ Cascade integration logged for ecosystem-sync-monitor workflow');
                console.log('   ThesisGallery and ecosystem repos will sync within 15 minutes');
              }
              
              // Delete branch
              if (pr.head.ref !== 'main' && pr.head.ref !== 'master') {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${pr.head.ref}`
                });
              }
            } else {
              console.log(`‚ö†Ô∏è PR #${pr.number} not mergeable: ${prData.mergeable_state}`);
            }
